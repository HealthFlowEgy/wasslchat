// WasslChat Database Schema
// Multi-Tenant WhatsApp Commerce & CRM Platform

generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["multiSchema", "postgresqlExtensions", "fullTextSearch"]
}

datasource db {
  provider   = "postgresql"
  url        = env("DATABASE_URL")
  extensions = [uuid_ossp(map: "uuid-ossp"), pgcrypto, vector]
  schemas    = ["public", "evolution"]
}

// ============================================================================
// SUBSCRIPTION & BILLING
// ============================================================================

model Plan {
  id                  String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  name                String
  nameAr              String?  @map("name_ar")
  slug                String   @unique
  description         String?
  descriptionAr       String?  @map("description_ar")
  priceMonthly        Decimal  @map("price_monthly") @db.Decimal(10, 2)
  priceAnnual         Decimal  @map("price_annual") @db.Decimal(10, 2)
  currency            String   @default("EGP")
  conversationsLimit  Int      @map("conversations_limit")
  teamMembersLimit    Int      @map("team_members_limit")
  productsLimit       Int      @map("products_limit")
  chatbotFlowsLimit   Int      @map("chatbot_flows_limit")
  broadcastsLimit     Int      @map("broadcasts_limit")
  storageLimit        Int      @default(1024) @map("storage_limit") // MB
  features            Json     @default("{}")
  whatsappApiType     String   @default("BAILEYS") @map("whatsapp_api_type") // BAILEYS, CLOUD_API
  aiResponsesType     String   @default("BASIC") @map("ai_responses_type") // BASIC, ADVANCED, GPT4, CUSTOM
  supportLevel        String   @default("EMAIL") @map("support_level") // EMAIL, CHAT, PRIORITY, DEDICATED
  isActive            Boolean  @default(true) @map("is_active")
  isPopular           Boolean  @default(false) @map("is_popular")
  sortOrder           Int      @default(0) @map("sort_order")
  createdAt           DateTime @default(now()) @map("created_at")
  updatedAt           DateTime @updatedAt @map("updated_at")

  tenants Tenant[]

  @@map("plans")
  @@schema("public")
}

// ============================================================================
// TENANT MANAGEMENT
// ============================================================================

model Tenant {
  id                String       @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  name              String
  nameAr            String?      @map("name_ar")
  slug              String       @unique
  subdomain         String       @unique
  domain            String?      @unique
  email             String
  phone             String?
  whatsappNumber    String?      @map("whatsapp_number")
  logo              String?
  favicon           String?
  timezone          String       @default("Africa/Cairo")
  locale            String       @default("ar-EG")
  currency          String       @default("EGP")
  countryCode       String       @default("EG") @map("country_code")
  address           Json?
  businessType      String?      @map("business_type")
  taxId             String?      @map("tax_id")
  commercialRegNo   String?      @map("commercial_reg_no")
  planId            String       @map("plan_id") @db.Uuid
  plan              Plan         @relation(fields: [planId], references: [id])
  status            TenantStatus @default(TRIAL)
  trialEndsAt       DateTime?    @map("trial_ends_at")
  subscriptionEndsAt DateTime?   @map("subscription_ends_at")
  billingCycle      String       @default("MONTHLY") @map("billing_cycle") // MONTHLY, ANNUAL
  settings          Json         @default("{}")
  branding          Json         @default("{}")
  metadata          Json         @default("{}")
  createdAt         DateTime     @default(now()) @map("created_at")
  updatedAt         DateTime     @updatedAt @map("updated_at")

  // Relations
  users             User[]
  contacts          Contact[]
  contactGroups     ContactGroup[]
  products          Product[]
  categories        Category[]
  orders            Order[]
  conversations     Conversation[]
  chatbotFlows      ChatbotFlow[]
  broadcasts        Broadcast[]
  broadcastTemplates BroadcastTemplate[]
  whatsappSessions  WhatsAppSession[]
  webhooks          Webhook[]
  apiKeys           ApiKey[]
  integrations      Integration[]
  usageRecords      UsageRecord[]
  invoices          Invoice[]

  @@index([status])
  @@index([planId])
  @@map("tenants")
  @@schema("public")
}

enum TenantStatus {
  ACTIVE
  TRIAL
  SUSPENDED
  CANCELLED
  PENDING_VERIFICATION

  @@schema("public")
}

// ============================================================================
// USER MANAGEMENT
// ============================================================================

model User {
  id                String    @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  tenantId          String    @map("tenant_id") @db.Uuid
  tenant            Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  email             String
  passwordHash      String    @map("password_hash")
  firstName         String    @map("first_name")
  lastName          String    @map("last_name")
  firstNameAr       String?   @map("first_name_ar")
  lastNameAr        String?   @map("last_name_ar")
  phone             String?
  avatar            String?
  role              UserRole  @default(AGENT)
  permissions       Json      @default("[]")
  isActive          Boolean   @default(true) @map("is_active")
  isEmailVerified   Boolean   @default(false) @map("is_email_verified")
  emailVerifiedAt   DateTime? @map("email_verified_at")
  lastLoginAt       DateTime? @map("last_login_at")
  lastLoginIp       String?   @map("last_login_ip")
  failedLoginAttempts Int     @default(0) @map("failed_login_attempts")
  lockedUntil       DateTime? @map("locked_until")
  twoFactorEnabled  Boolean   @default(false) @map("two_factor_enabled")
  twoFactorSecret   String?   @map("two_factor_secret")
  notificationSettings Json   @default("{}") @map("notification_settings")
  preferences       Json      @default("{}")
  createdAt         DateTime  @default(now()) @map("created_at")
  updatedAt         DateTime  @updatedAt @map("updated_at")

  // Relations
  assignedConversations Conversation[]  @relation("AssignedAgent")
  sentMessages          Message[]
  refreshTokens         RefreshToken[]
  passwordResets        PasswordReset[]
  activityLogs          ActivityLog[]

  @@unique([tenantId, email])
  @@index([tenantId])
  @@index([email])
  @@index([role])
  @@map("users")
  @@schema("public")
}

enum UserRole {
  OWNER
  ADMIN
  MANAGER
  AGENT
  VIEWER

  @@schema("public")
}

model RefreshToken {
  id          String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  userId      String   @map("user_id") @db.Uuid
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  token       String   @unique
  userAgent   String?  @map("user_agent")
  ipAddress   String?  @map("ip_address")
  expiresAt   DateTime @map("expires_at")
  revokedAt   DateTime? @map("revoked_at")
  createdAt   DateTime @default(now()) @map("created_at")

  @@index([userId])
  @@index([token])
  @@map("refresh_tokens")
  @@schema("public")
}

model PasswordReset {
  id        String    @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  userId    String    @map("user_id") @db.Uuid
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  token     String    @unique
  expiresAt DateTime  @map("expires_at")
  usedAt    DateTime? @map("used_at")
  createdAt DateTime  @default(now()) @map("created_at")

  @@index([token])
  @@map("password_resets")
  @@schema("public")
}

// ============================================================================
// CUSTOMER MANAGEMENT
// ============================================================================

model Contact {
  id              String    @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  tenantId        String    @map("tenant_id") @db.Uuid
  tenant          Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  whatsappId      String    @map("whatsapp_id")
  phone           String
  phoneCountryCode String   @default("EG") @map("phone_country_code")
  name            String?
  nameAr          String?   @map("name_ar")
  firstName       String?   @map("first_name")
  lastName        String?   @map("last_name")
  email           String?
  nationalId      String?   @map("national_id")
  nationalIdVerified Boolean @default(false) @map("national_id_verified")
  nationalIdVerifiedAt DateTime? @map("national_id_verified_at")
  avatar          String?
  dateOfBirth     DateTime? @map("date_of_birth")
  gender          String?
  language        String    @default("ar")
  source          String?   // WHATSAPP, IMPORT, MANUAL, API
  tags            String[]  @default([])
  customFields    Json      @default("{}") @map("custom_fields")
  address         Json?
  lifetimeValue   Decimal   @default(0) @map("lifetime_value") @db.Decimal(12, 2)
  ordersCount     Int       @default(0) @map("orders_count")
  totalSpent      Decimal   @default(0) @map("total_spent") @db.Decimal(12, 2)
  avgOrderValue   Decimal   @default(0) @map("avg_order_value") @db.Decimal(12, 2)
  lastOrderAt     DateTime? @map("last_order_at")
  lastContactAt   DateTime? @map("last_contact_at")
  firstContactAt  DateTime? @map("first_contact_at")
  isBlocked       Boolean   @default(false) @map("is_blocked")
  blockedReason   String?   @map("blocked_reason")
  blockedAt       DateTime? @map("blocked_at")
  metadata        Json      @default("{}")
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  // Relations
  conversations   Conversation[]
  orders          Order[]
  carts           Cart[]
  groups          ContactGroupMember[]
  broadcastRecipients BroadcastRecipient[]
  notes           ContactNote[]

  @@unique([tenantId, whatsappId])
  @@unique([tenantId, phone])
  @@index([tenantId])
  @@index([phone])
  @@index([email])
  @@index([nationalId])
  @@index([tags])
  @@map("contacts")
  @@schema("public")
}

model ContactNote {
  id          String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  contactId   String   @map("contact_id") @db.Uuid
  contact     Contact  @relation(fields: [contactId], references: [id], onDelete: Cascade)
  content     String
  createdById String?  @map("created_by_id") @db.Uuid
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@index([contactId])
  @@map("contact_notes")
  @@schema("public")
}

model ContactGroup {
  id          String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  tenantId    String   @map("tenant_id") @db.Uuid
  tenant      Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  name        String
  nameAr      String?  @map("name_ar")
  description String?
  color       String?
  filters     Json     @default("{}") // Dynamic filters for auto-grouping
  isAutomatic Boolean  @default(false) @map("is_automatic")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  members ContactGroupMember[]

  @@unique([tenantId, name])
  @@map("contact_groups")
  @@schema("public")
}

model ContactGroupMember {
  id        String       @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  groupId   String       @map("group_id") @db.Uuid
  group     ContactGroup @relation(fields: [groupId], references: [id], onDelete: Cascade)
  contactId String       @map("contact_id") @db.Uuid
  contact   Contact      @relation(fields: [contactId], references: [id], onDelete: Cascade)
  addedAt   DateTime     @default(now()) @map("added_at")

  @@unique([groupId, contactId])
  @@map("contact_group_members")
  @@schema("public")
}

// ============================================================================
// PRODUCT CATALOG
// ============================================================================

model Category {
  id              String     @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  tenantId        String     @map("tenant_id") @db.Uuid
  tenant          Tenant     @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  parentId        String?    @map("parent_id") @db.Uuid
  parent          Category?  @relation("CategoryHierarchy", fields: [parentId], references: [id])
  children        Category[] @relation("CategoryHierarchy")
  name            String
  nameAr          String?    @map("name_ar")
  slug            String
  description     String?
  descriptionAr   String?    @map("description_ar")
  image           String?
  icon            String?
  sortOrder       Int        @default(0) @map("sort_order")
  isActive        Boolean    @default(true) @map("is_active")
  isFeatured      Boolean    @default(false) @map("is_featured")
  metadata        Json       @default("{}")
  createdAt       DateTime   @default(now()) @map("created_at")
  updatedAt       DateTime   @updatedAt @map("updated_at")

  products Product[]

  @@unique([tenantId, slug])
  @@unique([tenantId, parentId, name])
  @@index([tenantId])
  @@index([parentId])
  @@map("categories")
  @@schema("public")
}

model Product {
  id                String    @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  tenantId          String    @map("tenant_id") @db.Uuid
  tenant            Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  categoryId        String?   @map("category_id") @db.Uuid
  category          Category? @relation(fields: [categoryId], references: [id])
  sku               String?
  barcode           String?
  name              String
  nameAr            String?   @map("name_ar")
  slug              String
  shortDescription  String?   @map("short_description")
  shortDescriptionAr String?  @map("short_description_ar")
  description       String?
  descriptionAr     String?   @map("description_ar")
  price             Decimal   @db.Decimal(10, 2)
  compareAtPrice    Decimal?  @map("compare_at_price") @db.Decimal(10, 2)
  costPrice         Decimal?  @map("cost_price") @db.Decimal(10, 2)
  currency          String    @default("EGP")
  inventoryQty      Int       @default(0) @map("inventory_qty")
  lowStockThreshold Int       @default(5) @map("low_stock_threshold")
  trackInventory    Boolean   @default(true) @map("track_inventory")
  allowBackorder    Boolean   @default(false) @map("allow_backorder")
  weight            Decimal?  @db.Decimal(10, 3) // kg
  dimensions        Json?     // { length, width, height }
  images            String[]  @default([])
  thumbnail         String?
  whatsappCatalogId String?   @map("whatsapp_catalog_id")
  whatsappProductId String?   @map("whatsapp_product_id")
  externalId        String?   @map("external_id") // For WooCommerce/Shopify sync
  externalSource    String?   @map("external_source")
  isActive          Boolean   @default(true) @map("is_active")
  isFeatured        Boolean   @default(false) @map("is_featured")
  isDigital         Boolean   @default(false) @map("is_digital")
  tags              String[]  @default([])
  attributes        Json      @default("{}") // Color, size, etc.
  variants          Json      @default("[]") // Product variants
  seoTitle          String?   @map("seo_title")
  seoDescription    String?   @map("seo_description")
  metadata          Json      @default("{}")
  viewCount         Int       @default(0) @map("view_count")
  soldCount         Int       @default(0) @map("sold_count")
  sortOrder         Int       @default(0) @map("sort_order")
  createdAt         DateTime  @default(now()) @map("created_at")
  updatedAt         DateTime  @updatedAt @map("updated_at")

  // Relations
  orderItems OrderItem[]
  cartItems  CartItem[]

  @@unique([tenantId, slug])
  @@unique([tenantId, sku])
  @@index([tenantId])
  @@index([categoryId])
  @@index([isActive])
  @@index([tags])
  @@map("products")
  @@schema("public")
}

// ============================================================================
// SHOPPING CART
// ============================================================================

model Cart {
  id              String    @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  tenantId        String    @map("tenant_id") @db.Uuid
  contactId       String    @map("contact_id") @db.Uuid
  contact         Contact   @relation(fields: [contactId], references: [id], onDelete: Cascade)
  sessionId       String?   @map("session_id")
  status          CartStatus @default(ACTIVE)
  subtotal        Decimal   @default(0) @db.Decimal(12, 2)
  itemsCount      Int       @default(0) @map("items_count")
  currency        String    @default("EGP")
  couponCode      String?   @map("coupon_code")
  discount        Decimal   @default(0) @db.Decimal(12, 2)
  abandonedAt     DateTime? @map("abandoned_at")
  recoveryEmailSent Boolean @default(false) @map("recovery_email_sent")
  recoveryWhatsappSent Boolean @default(false) @map("recovery_whatsapp_sent")
  convertedToOrderId String? @map("converted_to_order_id") @db.Uuid
  expiresAt       DateTime? @map("expires_at")
  metadata        Json      @default("{}")
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  items CartItem[]

  @@index([tenantId])
  @@index([contactId])
  @@index([status])
  @@map("carts")
  @@schema("public")
}

model CartItem {
  id          String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  cartId      String   @map("cart_id") @db.Uuid
  cart        Cart     @relation(fields: [cartId], references: [id], onDelete: Cascade)
  productId   String   @map("product_id") @db.Uuid
  product     Product  @relation(fields: [productId], references: [id])
  variantId   String?  @map("variant_id")
  quantity    Int      @default(1)
  price       Decimal  @db.Decimal(10, 2)
  totalPrice  Decimal  @map("total_price") @db.Decimal(10, 2)
  metadata    Json     @default("{}")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@unique([cartId, productId, variantId])
  @@map("cart_items")
  @@schema("public")
}

enum CartStatus {
  ACTIVE
  ABANDONED
  CONVERTED
  EXPIRED

  @@schema("public")
}

// ============================================================================
// ORDERS
// ============================================================================

model Order {
  id                String        @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  tenantId          String        @map("tenant_id") @db.Uuid
  tenant            Tenant        @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  contactId         String        @map("contact_id") @db.Uuid
  contact           Contact       @relation(fields: [contactId], references: [id])
  orderNumber       String        @map("order_number")
  status            OrderStatus   @default(PENDING)
  subtotal          Decimal       @db.Decimal(12, 2)
  discount          Decimal       @default(0) @db.Decimal(12, 2)
  discountCode      String?       @map("discount_code")
  shippingCost      Decimal       @default(0) @map("shipping_cost") @db.Decimal(12, 2)
  taxAmount         Decimal       @default(0) @map("tax_amount") @db.Decimal(12, 2)
  taxRate           Decimal       @default(0) @map("tax_rate") @db.Decimal(5, 4)
  total             Decimal       @db.Decimal(12, 2)
  currency          String        @default("EGP")
  itemsCount        Int           @map("items_count")
  paymentMethod     PaymentMethod @map("payment_method")
  paymentStatus     PaymentStatus @default(PENDING) @map("payment_status")
  paymentRef        String?       @map("payment_ref")
  paymentGateway    String?       @map("payment_gateway")
  paymentDetails    Json          @default("{}") @map("payment_details")
  shippingMethod    String?       @map("shipping_method")
  shippingAddress   Json?         @map("shipping_address")
  billingAddress    Json?         @map("billing_address")
  shippingTrackingNumber String?  @map("shipping_tracking_number")
  shippingTrackingUrl String?     @map("shipping_tracking_url")
  shippingCarrier   String?       @map("shipping_carrier")
  wasslboxShipmentId String?      @map("wasslbox_shipment_id")
  notes             String?
  internalNotes     String?       @map("internal_notes")
  source            String        @default("WHATSAPP") // WHATSAPP, DASHBOARD, API, IMPORT
  metadata          Json          @default("{}")
  ipAddress         String?       @map("ip_address")
  userAgent         String?       @map("user_agent")
  paidAt            DateTime?     @map("paid_at")
  confirmedAt       DateTime?     @map("confirmed_at")
  processedAt       DateTime?     @map("processed_at")
  shippedAt         DateTime?     @map("shipped_at")
  deliveredAt       DateTime?     @map("delivered_at")
  cancelledAt       DateTime?     @map("cancelled_at")
  cancellationReason String?      @map("cancellation_reason")
  refundedAt        DateTime?     @map("refunded_at")
  refundAmount      Decimal?      @map("refund_amount") @db.Decimal(12, 2)
  refundReason      String?       @map("refund_reason")
  createdAt         DateTime      @default(now()) @map("created_at")
  updatedAt         DateTime      @updatedAt @map("updated_at")

  items    OrderItem[]
  payments Payment[]
  timeline OrderTimeline[]

  @@unique([tenantId, orderNumber])
  @@index([tenantId])
  @@index([contactId])
  @@index([status])
  @@index([paymentStatus])
  @@index([createdAt])
  @@map("orders")
  @@schema("public")
}

model OrderItem {
  id            String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  orderId       String   @map("order_id") @db.Uuid
  order         Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  productId     String   @map("product_id") @db.Uuid
  product       Product  @relation(fields: [productId], references: [id])
  variantId     String?  @map("variant_id")
  sku           String?
  productName   String   @map("product_name")
  productNameAr String?  @map("product_name_ar")
  productImage  String?  @map("product_image")
  quantity      Int
  unitPrice     Decimal  @map("unit_price") @db.Decimal(10, 2)
  discount      Decimal  @default(0) @db.Decimal(10, 2)
  totalPrice    Decimal  @map("total_price") @db.Decimal(10, 2)
  metadata      Json     @default("{}")
  createdAt     DateTime @default(now()) @map("created_at")

  @@index([orderId])
  @@index([productId])
  @@map("order_items")
  @@schema("public")
}

model OrderTimeline {
  id          String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  orderId     String   @map("order_id") @db.Uuid
  order       Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  status      String
  title       String
  titleAr     String?  @map("title_ar")
  description String?
  descriptionAr String? @map("description_ar")
  createdById String?  @map("created_by_id") @db.Uuid
  metadata    Json     @default("{}")
  createdAt   DateTime @default(now()) @map("created_at")

  @@index([orderId])
  @@map("order_timeline")
  @@schema("public")
}

model Payment {
  id              String        @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  orderId         String        @map("order_id") @db.Uuid
  order           Order         @relation(fields: [orderId], references: [id], onDelete: Cascade)
  gateway         String        // FAWRY, HEALTHPAY, VODAFONE_CASH, INSTAPAY, COD
  method          PaymentMethod
  status          PaymentStatus @default(PENDING)
  amount          Decimal       @db.Decimal(12, 2)
  currency        String        @default("EGP")
  transactionId   String?       @map("transaction_id")
  referenceNumber String?       @map("reference_number")
  gatewayResponse Json          @default("{}") @map("gateway_response")
  failureReason   String?       @map("failure_reason")
  paidAt          DateTime?     @map("paid_at")
  refundedAt      DateTime?     @map("refunded_at")
  refundAmount    Decimal?      @map("refund_amount") @db.Decimal(12, 2)
  metadata        Json          @default("{}")
  createdAt       DateTime      @default(now()) @map("created_at")
  updatedAt       DateTime      @updatedAt @map("updated_at")

  @@index([orderId])
  @@index([transactionId])
  @@index([referenceNumber])
  @@map("payments")
  @@schema("public")
}

enum OrderStatus {
  PENDING
  CONFIRMED
  PROCESSING
  READY_FOR_PICKUP
  SHIPPED
  OUT_FOR_DELIVERY
  DELIVERED
  CANCELLED
  REFUNDED
  RETURNED
  ON_HOLD

  @@schema("public")
}

enum PaymentMethod {
  COD
  FAWRY
  FAWRY_PAY
  VODAFONE_CASH
  INSTAPAY
  HEALTHPAY
  CARD
  BANK_TRANSFER
  WALLET

  @@schema("public")
}

enum PaymentStatus {
  PENDING
  PROCESSING
  PAID
  FAILED
  CANCELLED
  REFUNDED
  PARTIALLY_REFUNDED
  EXPIRED

  @@schema("public")
}

// ============================================================================
// CONVERSATIONS & MESSAGES
// ============================================================================

model Conversation {
  id               String             @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  tenantId         String             @map("tenant_id") @db.Uuid
  tenant           Tenant             @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  contactId        String             @map("contact_id") @db.Uuid
  contact          Contact            @relation(fields: [contactId], references: [id])
  assignedUserId   String?            @map("assigned_user_id") @db.Uuid
  assignedUser     User?              @relation("AssignedAgent", fields: [assignedUserId], references: [id])
  whatsappSessionId String?           @map("whatsapp_session_id") @db.Uuid
  chatwootId       Int?               @map("chatwoot_id")
  chatwootInboxId  Int?               @map("chatwoot_inbox_id")
  status           ConversationStatus @default(OPEN)
  priority         ConversationPriority @default(NORMAL)
  channel          String             @default("whatsapp")
  subject          String?
  tags             String[]           @default([])
  customFields     Json               @default("{}") @map("custom_fields")
  firstMessageAt   DateTime?          @map("first_message_at")
  lastMessageAt    DateTime?          @map("last_message_at")
  lastAgentMessageAt DateTime?        @map("last_agent_message_at")
  lastContactMessageAt DateTime?      @map("last_contact_message_at")
  messagesCount    Int                @default(0) @map("messages_count")
  unreadCount      Int                @default(0) @map("unread_count")
  firstResponseTime Int?              @map("first_response_time") // seconds
  avgResponseTime  Int?               @map("avg_response_time") // seconds
  resolvedAt       DateTime?          @map("resolved_at")
  resolvedById     String?            @map("resolved_by_id") @db.Uuid
  slaBreached      Boolean            @default(false) @map("sla_breached")
  rating           Int?               // 1-5 stars
  feedback         String?
  metadata         Json               @default("{}")
  createdAt        DateTime           @default(now()) @map("created_at")
  updatedAt        DateTime           @updatedAt @map("updated_at")

  messages Message[]

  @@index([tenantId])
  @@index([contactId])
  @@index([assignedUserId])
  @@index([status])
  @@index([lastMessageAt])
  @@map("conversations")
  @@schema("public")
}

model Message {
  id                String             @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  conversationId    String             @map("conversation_id") @db.Uuid
  conversation      Conversation       @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  senderId          String?            @map("sender_id") @db.Uuid
  sender            User?              @relation(fields: [senderId], references: [id])
  whatsappMsgId     String?            @map("whatsapp_msg_id")
  chatwootMsgId     Int?               @map("chatwoot_msg_id")
  direction         MessageDirection
  contentType       MessageContentType @map("content_type")
  content           String
  contentAr         String?            @map("content_ar")
  mediaUrl          String?            @map("media_url")
  mediaType         String?            @map("media_type")
  mediaMimeType     String?            @map("media_mime_type")
  mediaSize         Int?               @map("media_size") // bytes
  mediaCaption      String?            @map("media_caption")
  thumbnailUrl      String?            @map("thumbnail_url")
  latitude          Decimal?           @db.Decimal(10, 8)
  longitude         Decimal?           @db.Decimal(11, 8)
  locationName      String?            @map("location_name")
  locationAddress   String?            @map("location_address")
  contactCard       Json?              @map("contact_card")
  interactiveData   Json?              @map("interactive_data") // Buttons, lists, etc.
  templateName      String?            @map("template_name")
  templateParams    Json?              @map("template_params")
  replyToMessageId  String?            @map("reply_to_message_id") @db.Uuid
  forwardedFrom     String?            @map("forwarded_from")
  isEdited          Boolean            @default(false) @map("is_edited")
  editedAt          DateTime?          @map("edited_at")
  isDeleted         Boolean            @default(false) @map("is_deleted")
  deletedAt         DateTime?          @map("deleted_at")
  isPrivate         Boolean            @default(false) @map("is_private") // Internal notes
  status            MessageStatus      @default(PENDING)
  sentAt            DateTime?          @map("sent_at")
  deliveredAt       DateTime?          @map("delivered_at")
  readAt            DateTime?          @map("read_at")
  failedAt          DateTime?          @map("failed_at")
  failureReason     String?            @map("failure_reason")
  metadata          Json               @default("{}")
  createdAt         DateTime           @default(now()) @map("created_at")
  updatedAt         DateTime           @updatedAt @map("updated_at")

  @@index([conversationId])
  @@index([whatsappMsgId])
  @@index([direction])
  @@index([createdAt])
  @@map("messages")
  @@schema("public")
}

enum ConversationStatus {
  OPEN
  PENDING
  SNOOZED
  RESOLVED
  BOT
  WAITING_FOR_CUSTOMER
  WAITING_FOR_AGENT

  @@schema("public")
}

enum ConversationPriority {
  LOW
  NORMAL
  HIGH
  URGENT

  @@schema("public")
}

enum MessageDirection {
  INBOUND
  OUTBOUND

  @@schema("public")
}

enum MessageContentType {
  TEXT
  IMAGE
  VIDEO
  AUDIO
  VOICE
  DOCUMENT
  LOCATION
  CONTACT
  STICKER
  INTERACTIVE
  TEMPLATE
  REACTION
  SYSTEM

  @@schema("public")
}

enum MessageStatus {
  PENDING
  QUEUED
  SENT
  DELIVERED
  READ
  FAILED

  @@schema("public")
}

// ============================================================================
// CHATBOT & AUTOMATION
// ============================================================================

model ChatbotFlow {
  id              String      @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  tenantId        String      @map("tenant_id") @db.Uuid
  tenant          Tenant      @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  name            String
  nameAr          String?     @map("name_ar")
  description     String?
  descriptionAr   String?     @map("description_ar")
  triggerType     TriggerType @default(KEYWORD) @map("trigger_type")
  triggerKeywords String[]    @default([]) @map("trigger_keywords")
  triggerRegex    String?     @map("trigger_regex")
  triggerConditions Json      @default("{}") @map("trigger_conditions")
  flowDefinition  Json        @map("flow_definition")
  typebotId       String?     @map("typebot_id")
  typebotPublicId String?     @map("typebot_public_id")
  n8nWorkflowId   String?     @map("n8n_workflow_id")
  isActive        Boolean     @default(false) @map("is_active")
  priority        Int         @default(0)
  scheduleStart   String?     @map("schedule_start") // HH:mm
  scheduleEnd     String?     @map("schedule_end")   // HH:mm
  scheduleDays    Int[]       @default([]) @map("schedule_days") // 0=Sunday
  handoffEnabled  Boolean     @default(true) @map("handoff_enabled")
  handoffKeywords String[]    @default(["agent", "human", "support"]) @map("handoff_keywords")
  aiEnabled       Boolean     @default(false) @map("ai_enabled")
  aiModel         String?     @map("ai_model") // gpt-4, claude-3
  aiSystemPrompt  String?     @map("ai_system_prompt")
  stats           Json        @default("{}") // { triggered, completed, handoffs, avgDuration }
  version         Int         @default(1)
  publishedAt     DateTime?   @map("published_at")
  metadata        Json        @default("{}")
  createdAt       DateTime    @default(now()) @map("created_at")
  updatedAt       DateTime    @updatedAt @map("updated_at")

  sessions ChatbotSession[]

  @@index([tenantId])
  @@index([isActive])
  @@map("chatbot_flows")
  @@schema("public")
}

model ChatbotSession {
  id            String       @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  flowId        String       @map("flow_id") @db.Uuid
  flow          ChatbotFlow  @relation(fields: [flowId], references: [id], onDelete: Cascade)
  contactId     String       @map("contact_id") @db.Uuid
  conversationId String?     @map("conversation_id") @db.Uuid
  currentNodeId String?      @map("current_node_id")
  status        ChatbotSessionStatus @default(ACTIVE)
  variables     Json         @default("{}")
  history       Json         @default("[]")
  startedAt     DateTime     @default(now()) @map("started_at")
  completedAt   DateTime?    @map("completed_at")
  handedOffAt   DateTime?    @map("handed_off_at")
  metadata      Json         @default("{}")

  @@index([flowId])
  @@index([contactId])
  @@map("chatbot_sessions")
  @@schema("public")
}

enum TriggerType {
  KEYWORD
  FIRST_MESSAGE
  REGEX
  CONDITION
  WEBHOOK
  SCHEDULE
  ALL_MESSAGES

  @@schema("public")
}

enum ChatbotSessionStatus {
  ACTIVE
  PAUSED
  COMPLETED
  HANDED_OFF
  EXPIRED
  FAILED

  @@schema("public")
}

// ============================================================================
// BROADCASTS & CAMPAIGNS
// ============================================================================

model BroadcastTemplate {
  id          String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  tenantId    String   @map("tenant_id") @db.Uuid
  tenant      Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  name        String
  nameAr      String?  @map("name_ar")
  whatsappTemplateName String? @map("whatsapp_template_name")
  whatsappTemplateId String?   @map("whatsapp_template_id")
  category    String   // MARKETING, UTILITY, AUTHENTICATION
  language    String   @default("ar")
  headerType  String?  @map("header_type") // TEXT, IMAGE, VIDEO, DOCUMENT
  headerContent String? @map("header_content")
  body        String
  bodyVariables String[] @default([]) @map("body_variables")
  footer      String?
  buttons     Json     @default("[]")
  status      String   @default("DRAFT") // DRAFT, PENDING, APPROVED, REJECTED
  rejectionReason String? @map("rejection_reason")
  submittedAt DateTime? @map("submitted_at")
  approvedAt  DateTime? @map("approved_at")
  metadata    Json     @default("{}")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  broadcasts Broadcast[]

  @@unique([tenantId, name])
  @@map("broadcast_templates")
  @@schema("public")
}

model Broadcast {
  id              String           @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  tenantId        String           @map("tenant_id") @db.Uuid
  tenant          Tenant           @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  templateId      String?          @map("template_id") @db.Uuid
  template        BroadcastTemplate? @relation(fields: [templateId], references: [id])
  name            String
  description     String?
  audienceType    String           @default("ALL") @map("audience_type") // ALL, GROUP, FILTER, MANUAL
  audienceGroupId String?          @map("audience_group_id") @db.Uuid
  audienceFilter  Json             @default("{}") @map("audience_filter")
  content         Json             // Message content with variables
  scheduledAt     DateTime?        @map("scheduled_at")
  sentAt          DateTime?        @map("sent_at")
  completedAt     DateTime?        @map("completed_at")
  status          BroadcastStatus  @default(DRAFT)
  totalRecipients Int              @default(0) @map("total_recipients")
  sentCount       Int              @default(0) @map("sent_count")
  deliveredCount  Int              @default(0) @map("delivered_count")
  readCount       Int              @default(0) @map("read_count")
  failedCount     Int              @default(0) @map("failed_count")
  repliedCount    Int              @default(0) @map("replied_count")
  optOutCount     Int              @default(0) @map("opt_out_count")
  estimatedCost   Decimal          @default(0) @map("estimated_cost") @db.Decimal(10, 2)
  actualCost      Decimal          @default(0) @map("actual_cost") @db.Decimal(10, 2)
  createdById     String?          @map("created_by_id") @db.Uuid
  metadata        Json             @default("{}")
  createdAt       DateTime         @default(now()) @map("created_at")
  updatedAt       DateTime         @updatedAt @map("updated_at")

  recipients BroadcastRecipient[]

  @@index([tenantId])
  @@index([status])
  @@index([scheduledAt])
  @@map("broadcasts")
  @@schema("public")
}

model BroadcastRecipient {
  id           String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  broadcastId  String   @map("broadcast_id") @db.Uuid
  broadcast    Broadcast @relation(fields: [broadcastId], references: [id], onDelete: Cascade)
  contactId    String   @map("contact_id") @db.Uuid
  contact      Contact  @relation(fields: [contactId], references: [id], onDelete: Cascade)
  whatsappId   String   @map("whatsapp_id")
  status       String   @default("PENDING") // PENDING, SENT, DELIVERED, READ, FAILED
  sentAt       DateTime? @map("sent_at")
  deliveredAt  DateTime? @map("delivered_at")
  readAt       DateTime? @map("read_at")
  failedAt     DateTime? @map("failed_at")
  failureReason String?  @map("failure_reason")
  repliedAt    DateTime? @map("replied_at")
  optedOutAt   DateTime? @map("opted_out_at")
  messageId    String?   @map("message_id")
  metadata     Json     @default("{}")
  createdAt    DateTime @default(now()) @map("created_at")

  @@unique([broadcastId, contactId])
  @@index([broadcastId])
  @@index([status])
  @@map("broadcast_recipients")
  @@schema("public")
}

enum BroadcastStatus {
  DRAFT
  SCHEDULED
  SENDING
  PAUSED
  SENT
  COMPLETED
  CANCELLED
  FAILED

  @@schema("public")
}

// ============================================================================
// WHATSAPP SESSION MANAGEMENT
// ============================================================================

model WhatsAppSession {
  id              String         @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  tenantId        String         @map("tenant_id") @db.Uuid
  tenant          Tenant         @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  instanceName    String         @map("instance_name")
  instanceId      String?        @map("instance_id")
  phoneNumber     String?        @map("phone_number")
  displayName     String?        @map("display_name")
  profilePicture  String?        @map("profile_picture")
  connectionType  ConnectionType @default(BAILEYS) @map("connection_type")
  status          WhatsAppSessionStatus  @default(DISCONNECTED)
  qrCode          String?        @map("qr_code")
  qrCodeExpiresAt DateTime?      @map("qr_code_expires_at")
  pairingCode     String?        @map("pairing_code")
  lastConnectedAt DateTime?      @map("last_connected_at")
  lastDisconnectedAt DateTime?   @map("last_disconnected_at")
  disconnectReason String?       @map("disconnect_reason")
  webhookUrl      String?        @map("webhook_url")
  webhookEvents   String[]       @default([]) @map("webhook_events")
  chatwootAccountId Int?         @map("chatwoot_account_id")
  chatwootInboxId Int?           @map("chatwoot_inbox_id")
  settings        Json           @default("{}")
  metadata        Json           @default("{}")
  messagesSent    Int            @default(0) @map("messages_sent")
  messagesReceived Int           @default(0) @map("messages_received")
  createdAt       DateTime       @default(now()) @map("created_at")
  updatedAt       DateTime       @updatedAt @map("updated_at")

  @@unique([tenantId, instanceName])
  @@index([tenantId])
  @@index([status])
  @@map("whatsapp_sessions")
  @@schema("public")
}

enum ConnectionType {
  BAILEYS
  CLOUD_API

  @@schema("public")
}

enum WhatsAppSessionStatus {
  CONNECTED
  DISCONNECTED
  CONNECTING
  QR_CODE
  PAIRING_CODE
  LOGGED_OUT
  BANNED

  @@schema("public")
}

// ============================================================================
// INTEGRATIONS & WEBHOOKS
// ============================================================================

model Integration {
  id            String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  tenantId      String   @map("tenant_id") @db.Uuid
  tenant        Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  type          String   // WOOCOMMERCE, SHOPIFY, HEALTHPAY, WASSLBOX, CUSTOM
  name          String
  config        Json     @default("{}")
  credentials   Json     @default("{}") // Encrypted
  isActive      Boolean  @default(true) @map("is_active")
  lastSyncAt    DateTime? @map("last_sync_at")
  lastSyncStatus String?  @map("last_sync_status")
  lastSyncError String?  @map("last_sync_error")
  syncSettings  Json     @default("{}") @map("sync_settings")
  metadata      Json     @default("{}")
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  @@unique([tenantId, type, name])
  @@map("integrations")
  @@schema("public")
}

model Webhook {
  id          String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  tenantId    String   @map("tenant_id") @db.Uuid
  tenant      Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  name        String
  url         String
  secret      String?
  events      String[] @default([])
  isActive    Boolean  @default(true) @map("is_active")
  headers     Json     @default("{}")
  retryCount  Int      @default(3) @map("retry_count")
  timeoutMs   Int      @default(30000) @map("timeout_ms")
  lastTriggeredAt DateTime? @map("last_triggered_at")
  lastStatus  Int?     @map("last_status")
  metadata    Json     @default("{}")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  deliveries WebhookDelivery[]

  @@unique([tenantId, name])
  @@map("webhooks")
  @@schema("public")
}

model WebhookDelivery {
  id          String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  webhookId   String   @map("webhook_id") @db.Uuid
  webhook     Webhook  @relation(fields: [webhookId], references: [id], onDelete: Cascade)
  event       String
  payload     Json
  response    Json?
  statusCode  Int?     @map("status_code")
  duration    Int?     // ms
  attempt     Int      @default(1)
  error       String?
  deliveredAt DateTime? @map("delivered_at")
  createdAt   DateTime @default(now()) @map("created_at")

  @@index([webhookId])
  @@index([createdAt])
  @@map("webhook_deliveries")
  @@schema("public")
}

model ApiKey {
  id          String    @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  tenantId    String    @map("tenant_id") @db.Uuid
  tenant      Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  name        String
  keyHash     String    @unique @map("key_hash")
  keyPrefix   String    @map("key_prefix") // First 8 chars for identification
  permissions String[]  @default([])
  rateLimit   Int       @default(1000) @map("rate_limit") // per hour
  expiresAt   DateTime? @map("expires_at")
  lastUsedAt  DateTime? @map("last_used_at")
  lastUsedIp  String?   @map("last_used_ip")
  usageCount  Int       @default(0) @map("usage_count")
  isActive    Boolean   @default(true) @map("is_active")
  createdById String?   @map("created_by_id") @db.Uuid
  metadata    Json      @default("{}")
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  @@unique([tenantId, name])
  @@map("api_keys")
  @@schema("public")
}

// ============================================================================
// USAGE & BILLING
// ============================================================================

model UsageRecord {
  id          String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  tenantId    String   @map("tenant_id") @db.Uuid
  tenant      Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  type        String   // CONVERSATION, MESSAGE, AI_TOKEN, STORAGE, API_CALL
  quantity    Int      @default(1)
  unitCost    Decimal  @default(0) @map("unit_cost") @db.Decimal(10, 6)
  totalCost   Decimal  @default(0) @map("total_cost") @db.Decimal(10, 2)
  metadata    Json     @default("{}")
  periodStart DateTime @map("period_start")
  periodEnd   DateTime @map("period_end")
  createdAt   DateTime @default(now()) @map("created_at")

  @@index([tenantId])
  @@index([type])
  @@index([periodStart, periodEnd])
  @@map("usage_records")
  @@schema("public")
}

model Invoice {
  id            String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  tenantId      String   @map("tenant_id") @db.Uuid
  tenant        Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  invoiceNumber String   @unique @map("invoice_number")
  status        String   @default("DRAFT") // DRAFT, SENT, PAID, OVERDUE, CANCELLED
  subtotal      Decimal  @db.Decimal(12, 2)
  tax           Decimal  @default(0) @db.Decimal(12, 2)
  total         Decimal  @db.Decimal(12, 2)
  currency      String   @default("EGP")
  items         Json     @default("[]")
  periodStart   DateTime @map("period_start")
  periodEnd     DateTime @map("period_end")
  dueDate       DateTime @map("due_date")
  paidAt        DateTime? @map("paid_at")
  paymentMethod String?  @map("payment_method")
  paymentRef    String?  @map("payment_ref")
  notes         String?
  metadata      Json     @default("{}")
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  @@index([tenantId])
  @@index([status])
  @@map("invoices")
  @@schema("public")
}

// ============================================================================
// ACTIVITY & AUDIT LOGS
// ============================================================================

model ActivityLog {
  id          String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  tenantId    String?  @map("tenant_id") @db.Uuid
  userId      String?  @map("user_id") @db.Uuid
  user        User?    @relation(fields: [userId], references: [id])
  action      String   // CREATE, UPDATE, DELETE, LOGIN, LOGOUT, etc.
  entity      String   // order, product, contact, etc.
  entityId    String?  @map("entity_id") @db.Uuid
  oldValues   Json?    @map("old_values")
  newValues   Json?    @map("new_values")
  ipAddress   String?  @map("ip_address")
  userAgent   String?  @map("user_agent")
  metadata    Json     @default("{}")
  createdAt   DateTime @default(now()) @map("created_at")

  @@index([tenantId])
  @@index([userId])
  @@index([action])
  @@index([entity])
  @@index([createdAt])
  @@map("activity_logs")
  @@schema("public")
}

// ============================================================================
// CANNED RESPONSES
// ============================================================================

model CannedResponse {
  id          String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  tenantId    String   @map("tenant_id") @db.Uuid
  shortCode   String   @map("short_code")
  title       String
  titleAr     String?  @map("title_ar")
  content     String
  contentAr   String?  @map("content_ar")
  category    String?
  attachments String[] @default([])
  isGlobal    Boolean  @default(false) @map("is_global")
  usageCount  Int      @default(0) @map("usage_count")
  createdById String?  @map("created_by_id") @db.Uuid
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@unique([tenantId, shortCode])
  @@map("canned_responses")
  @@schema("public")
}
